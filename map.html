<!DOCTYPE html>

<html>

<head>
    <meta charset="UTF-8">
    <title>My map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <link rel="stylesheet" href="first.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#RESET").click(function () {
                $.ajax({//light1
                    url: 'http://localhost:3000/lights/61c771c66a2243a32d0e24d6',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "illuminancelevel": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//light2
                    url: 'http://localhost:3000/lights/61c772196a2243a32d0e24d9',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "illuminancelevel": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//light3
                    url: 'http://localhost:3000/lights/61c772bf6a2243a32d0e24dc',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "illuminancelevel": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//light4
                    url: 'http://localhost:3000/lights/61c772d46a2243a32d0e24de',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "illuminancelevel": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//light5
                    url: 'http://localhost:3000/lights/61c772de6a2243a32d0e24e0',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "illuminancelevel": "0",
                        "status": "ok"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//light6
                    url: 'http://localhost:3000/lights/61c772e66a2243a32d0e24e2',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "illuminancelevel": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//motion1
                    url: 'http://localhost:3000/motions/61c776eb379feb93a78f2b21',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "value": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//motion2
                    url: 'http://localhost:3000/motions/61c7774a379feb93a78f2b23',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "value": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//motion3
                    url: 'http://localhost:3000/motions/61c77754379feb93a78f2b25',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "value": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });
                $.ajax({//motion4
                    url: 'http://localhost:3000/motions/61c7775f379feb93a78f2b27',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "value": "0"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) { }

                });

            });



            //$("button").click(function(){
            //ajax xwris success, arxikes times
            //mporei na xreiastei 2 refreshes
            $.get("http://localhost:3000/lights", function (data, status) {
                //console.log("Data: " + data + "\nStatus: " + status);
                //console.log(data);
                //console.log(data[0]);
                //console.log(data[0].location.coordinates);

                for (let i = 0; i < data.length; i++) {
                    var marker = L.marker(data[i].location.coordinates, { icon: leafletIcon }).addTo(map);
                    marker.bindPopup("<b> Street Light " + (i + 1) + "</b><br> illuminancelevel: " + '<span id="demo">' + data[i].illuminancelevel[0] + '</span>' + "<br> status: " + data[i].status + "<br>" + '<input type="range" min="0" max="100" step="10" value=' + data[i].illuminancelevel[0] * 100 + ' class="slider" id="myrange">').on("popupopen", () => {
                        var slider = document.getElementById("myrange");
                        var output = document.getElementById("demo");

                        slider.oninput = function () {
                            output.innerHTML = this.value / 100;
                            if (i == 0) {
                                $.ajax({//light1
                                    url: 'http://localhost:3000/lights/61c771c66a2243a32d0e24d6',
                                    type: 'PATCH',
                                    data: JSON.stringify({
                                        "illuminancelevel": this.value / 100
                                    }),
                                    contentType: "application/json",
                                    dataType: "json",
                                    success: function (data) { }

                                });

                            }
                            if (i == 1) {
                                $.ajax({//light2
                                    url: 'http://localhost:3000/lights/61c772196a2243a32d0e24d9',
                                    type: 'PATCH',
                                    data: JSON.stringify({
                                        "illuminancelevel": this.value / 100
                                    }),
                                    contentType: "application/json",
                                    dataType: "json",
                                    success: function (data) { }

                                });

                            }
                            if (i == 2) {
                                $.ajax({//light3
                                    url: 'http://localhost:3000/lights/61c772bf6a2243a32d0e24dc',
                                    type: 'PATCH',
                                    data: JSON.stringify({
                                        "illuminancelevel": this.value / 100
                                    }),
                                    contentType: "application/json",
                                    dataType: "json",
                                    success: function (data) { }

                                });

                            }
                            if (i == 3) {
                                $.ajax({//light4
                                    url: 'http://localhost:3000/lights/61c772d46a2243a32d0e24de',
                                    type: 'PATCH',
                                    data: JSON.stringify({
                                        "illuminancelevel": this.value / 100
                                    }),
                                    contentType: "application/json",
                                    dataType: "json",
                                    success: function (data) { }

                                });

                            }
                            if (i == 4) {
                                $.ajax({//light5
                                    url: 'http://localhost:3000/lights/61c772de6a2243a32d0e24e0',
                                    type: 'PATCH',
                                    data: JSON.stringify({
                                        "illuminancelevel": this.value / 100
                                    }),
                                    contentType: "application/json",
                                    dataType: "json",
                                    success: function (data) { }

                                });

                            }
                            if (i == 5) {
                                $.ajax({//light6
                                    url: 'http://localhost:3000/lights/61c772e66a2243a32d0e24e2',
                                    type: 'PATCH',
                                    data: JSON.stringify({
                                        "illuminancelevel": this.value / 100
                                    }),
                                    contentType: "application/json",
                                    dataType: "json",
                                    success: function (data) { }

                                });

                            }


                        }
                    });
                };
            });
            $("#scenario1").click(function () {//scenario1: he have motion in motion detector 1 and the outdoors illuminance level is bellow 1000 then we have to put our illuminance level of the street lights to 0.5
                $.ajax({//motion1
                    url: 'http://localhost:3000/motions/61c776eb379feb93a78f2b21',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "value": "1"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) {
                        $.get("http://localhost:3000/motions", function (data, status) {
                            for (let i = 0; i < data.length; i++) {
                                var marker = L.marker(data[i].location.coordinates, { icon: leafletIcon2 }).addTo(map);
                                marker.bindPopup("<b> Motion Detector " + (i + 1) + "</b><br> value: " + data[i].value);
                            }
                        });
                        //5 patches ta lights, sto teleytaio sto success $.get(lights.copy)
                        $.ajax({//light1
                            url: 'http://localhost:3000/lights/61c771c66a2243a32d0e24d6',
                            type: 'PATCH',
                            data: JSON.stringify({
                                "illuminancelevel": "0.5"
                            }),
                            contentType: "application/json",
                            dataType: "json",
                            success: function (data) { }

                        });
                        $.ajax({//light2
                            url: 'http://localhost:3000/lights/61c772196a2243a32d0e24d9',
                            type: 'PATCH',
                            data: JSON.stringify({
                                "illuminancelevel": "0.5"
                            }),
                            contentType: "application/json",
                            dataType: "json",
                            success: function (data) { }

                        });
                        $.ajax({//light3
                            url: 'http://localhost:3000/lights/61c772bf6a2243a32d0e24dc',
                            type: 'PATCH',
                            data: JSON.stringify({
                                "illuminancelevel": "0.5"
                            }),
                            contentType: "application/json",
                            dataType: "json",
                            success: function (data) { }

                        });
                        $.ajax({//light4
                            url: 'http://localhost:3000/lights/61c772d46a2243a32d0e24de',
                            type: 'PATCH',
                            data: JSON.stringify({
                                "illuminancelevel": "0.5"
                            }),
                            contentType: "application/json",
                            dataType: "json",
                            success: function (data) { }

                        });
                        $.ajax({//light5
                            url: 'http://localhost:3000/lights/61c772de6a2243a32d0e24e0',
                            type: 'PATCH',
                            data: JSON.stringify({
                                "illuminancelevel": "0.5"
                            }),
                            contentType: "application/json",
                            dataType: "json",
                            success: function (data) { }

                        });
                        $.ajax({//light6
                            url: 'http://localhost:3000/lights/61c772e66a2243a32d0e24e2',
                            type: 'PATCH',
                            data: JSON.stringify({
                                "illuminancelevel": "0.5"
                            }),
                            contentType: "application/json",
                            dataType: "json",
                            success: function (data) {
                                $.get("http://localhost:3000/lights", function (data, status) {

                                    for (let i = 0; i < data.length; i++) {
                                        var marker = L.marker(data[i].location.coordinates, { icon: leafletIcon }).addTo(map);
                                        marker.bindPopup("<b> Street Light " + (i + 1) + "</b><br> illuminancelevel: " + '<span id="demo">' + data[i].illuminancelevel[0] + '</span>' + "<br> status: " + data[i].status + "<br>" + '<input type="range" min="0" max="100" step="10" value=' + data[i].illuminancelevel[0] * 100 + ' class="slider" id="myrange">').on("popupopen", () => {
                                            var slider = document.getElementById("myrange");
                                            var output = document.getElementById("demo");

                                            slider.oninput = function () {
                                                output.innerHTML = this.value / 100;
                                            }
                                        });
                                    };
                                });
                            }

                        });

                    }

                });
            });
            $("#scenario2").click(function () {//success { get light/id {copy}
                $.ajax({//light5
                    url: 'http://localhost:3000/lights/61c772de6a2243a32d0e24e0',
                    type: 'PATCH',
                    data: JSON.stringify({
                        "illuminancelevel": "-",
                        "status": "not ok"
                    }),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) {
                        $.get("http://localhost:3000/lights", function (data, status) {
                            var marker = L.marker(data[4].location.coordinates, { icon: leafletIcon }).addTo(map);
                            marker.bindPopup("<b> Street Light 5" + "</b><br> illuminancelevel: -" + "<br> status: not ok");
                            var circle = L.circle([38.287108, 21.786964], {
                                color: 'red',
                                fillColor: '#f03',
                                fillOpacity: 0.5,
                                radius: 20
                            }).addTo(map);
                        });
                    }
                });
            })
        });


        $.get("http://localhost:3000/motions", function (data, status) {
            for (let i = 0; i < data.length; i++) {
                var marker = L.marker(data[i].location.coordinates, { icon: leafletIcon2 }).addTo(map);
                marker.bindPopup("<b> Motion Detector " + (i + 1) + "</b><br> value: " + data[i].value);
            }
        });

        $.get("http://localhost:3000/weather", function (data, status) {
            var marker = L.marker(data[0].location.coordinates, { icon: leafletIcon1 }).addTo(map);
            marker.bindPopup("<b> Weather Station " + "</b><br> value: " + data[0].value);
        });

        $.get("http://localhost:3000/weatherobs", function (data, status) {
            var marker = L.marker(data[0].location.coordinates, { icon: leafletIcon1 }).addTo(map);
            marker.bindPopup("<b> Weather Observer " + "</b><br> illuminance: " + data[0].illuminance + "<br> temperature: " + data[0].temperature);
        });


    </script>
</head>

<body>
    <button id="RESET">RESET</button>
    <button id="scenario1">Scenario 1</button>
    <button id="scenario2">Scenario 2</button>
    <div id="map"></div>
    <script>
        var map = L.map('map').setView([38.28728865804488, 21.787650762141062], 20);

        L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=8VJKWUfOUdZuP4g39mJ1', {
            attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
        }).addTo(map);

        var leafletIcon = L.icon({ //https://www.prokat-assos.gr/wp-content/uploads/2017/05/map-marker-icon.png
            iconUrl: 'https://static.thenounproject.com/png/104296-200.png',
            iconSize: [50, 50],
            iconAnchor: [22, 54],
            popupAnchor: [0, -60]
        })

        var leafletIcon2 = L.icon({
            iconUrl: 'https://icon-library.com/images/motion-sensor-icon/motion-sensor-icon-16.jpg',
            iconSize: [50, 50],
            iconAnchor: [22, 54],
            popupAnchor: [0, -60]
        })

        var leafletIcon1 = L.icon({
            iconUrl: 'https://cdn3.iconfinder.com/data/icons/map-markers-2-1/512/fog_cloud-512.png',
            iconSize: [50, 50],
            iconAnchor: [22, 54],
            popupAnchor: [0, -60]
        })
            //var marker = L.marker([38.28728865804488, 21.787650762141062]).addTo(map);
            //marker.bindPopup("<b> Street Light 1 </b><br> I am the first light.").openPopup();
    </script>
</body>

</html>